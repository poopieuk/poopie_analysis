// =====================================================
// Global configuration for Poopie Pipeline
// Compatible with local + Seqera Cloud (AWS Batch)
// =====================================================

manifest {
    name        = 'poopieuk/poopie_analysis'
    author      = 'Alisha Ahamed'
    description = '16S rRNA microbiome pipeline with PDF reports'
    version     = '1.0.0'
}

// -----------------------------------------------------
// Default parameters (overridden by CLI or profiles)
// -----------------------------------------------------
params {
    input_dir        = "s3://poopie-data/"
    output_dir       = "${projectDir}/results"
    tax_train        = "s3://poopie-data/silva_nr_v138_train_set.fa.gz"
    tax_species      = "s3://poopie-data/silva_species_assignment_v138.fa.gz"
    preprocess_r     = "${projectDir}/poopie_pipeline.R"
    summary_r        = "${projectDir}/generate_summary_single.R"
    biomarker_r      = "${projectDir}/biomarker_single.R"
    report_py        = "${projectDir}/poopie_report.py"
    kb_json          = "${projectDir}/pp_report.json"
    sample_id        = null

    supabase_url     = System.getenv('SUPABASE_URL') ?: 'https://tbyenonhykkizfdbcpnz.supabase.co'
    supabase_key     = System.getenv('SUPABASE_KEY') ?: 'YOUR_SUPABASE_KEY'
    supabase_bucket  = System.getenv('SUPABASE_BUCKET') ?: 'reports'
}

// -----------------------------------------------------
// Executor defaults
// -----------------------------------------------------
process {
    errorStrategy = 'terminate'
    maxRetries    = 1
    cpus          = 4
    memory        = '8 GB'
    time          = '6h'
    container     = 'rocker/tidyverse:4.3.1'
}

// -----------------------------------------------------
// Profiles
// -----------------------------------------------------
profiles {

    // ---------- LOCAL / DOCKER ----------
    standard {
        process.executor = 'local'
        docker.enabled   = true
        docker.runOptions = '-u \$(id -u):\$(id -g)'
        workDir = "${projectDir}/work"
    }

    // ---------- AWS BATCH / SEQERA CLOUD ----------
  

    awsbatch {
        process.executor = 'awsbatch'
        process.container = 'rocker/tidyverse:4.3.1'

        aws.region = 'eu-west-2'
        aws.batch.jobQueue = 'TowerForge-npegNvRMSGdHwp42n73Y-work'
        aws.batch.jobDefinition = 'nf-rocker-tidyverse-4-3-1'

        workDir = 's3://poopie-data/scratch'
    }



    // ---------- TEST ----------
    test {
        process.executor = 'local'
        params.input_dir = "${projectDir}/test_data"
        workDir          = "${projectDir}/work_test"
    }
}

// -----------------------------------------------------
// Log formatting & tracing
// -----------------------------------------------------
timeline {
    enabled = true
    file    = "${params.output_dir}/timeline.html"
}
trace {
    enabled = true
    file    = "${params.output_dir}/trace.txt"
}
report {
    enabled = true
    file    = "${params.output_dir}/execution_report.html"
}
dag {
    enabled = true
    file    = "${params.output_dir}/dag.png"
}
